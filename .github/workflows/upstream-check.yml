# Upstream Sync Notification
#
# This workflow checks if the upstream repository has new commits
# and creates an issue to notify maintainers.
#
# It does NOT automatically rebase - that should be done manually
# to handle conflicts properly.

name: Check Upstream

on:
  schedule:
    # Run weekly on Monday at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/AutoMaker-Org/automaker.git
          git fetch upstream

      - name: Check for new commits
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind_count=$BEHIND" >> $GITHUB_OUTPUT

          if [ $BEHIND -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Get summary of new commits
            echo "## New Upstream Commits" > /tmp/commits.md
            echo "" >> /tmp/commits.md
            echo "There are **$BEHIND** new commits in upstream." >> /tmp/commits.md
            echo "" >> /tmp/commits.md
            echo "### Recent Changes:" >> /tmp/commits.md
            echo '```' >> /tmp/commits.md
            git log --oneline HEAD..upstream/main | head -20 >> /tmp/commits.md
            echo '```' >> /tmp/commits.md

            if [ $BEHIND -gt 20 ]; then
              echo "" >> /tmp/commits.md
              echo "_...and $(($BEHIND - 20)) more commits_" >> /tmp/commits.md
            fi

            echo "" >> /tmp/commits.md
            echo "### Files Changed:" >> /tmp/commits.md
            echo '```' >> /tmp/commits.md
            git diff --stat HEAD..upstream/main | tail -20 >> /tmp/commits.md
            echo '```' >> /tmp/commits.md

            echo "" >> /tmp/commits.md
            echo "## How to Sync" >> /tmp/commits.md
            echo "" >> /tmp/commits.md
            echo '```bash' >> /tmp/commits.md
            echo "# Preview changes" >> /tmp/commits.md
            echo "./scripts/sync-upstream.sh --dry-run" >> /tmp/commits.md
            echo "" >> /tmp/commits.md
            echo "# Perform sync" >> /tmp/commits.md
            echo "./scripts/sync-upstream.sh" >> /tmp/commits.md
            echo "" >> /tmp/commits.md
            echo "# Test after sync" >> /tmp/commits.md
            echo "npm run test:all" >> /tmp/commits.md
            echo "" >> /tmp/commits.md
            echo "# Push (no force needed)" >> /tmp/commits.md
            echo "git push origin main" >> /tmp/commits.md
            echo '```' >> /tmp/commits.md

            # Store for issue body
            COMMITS_SUMMARY=$(cat /tmp/commits.md)
            echo "COMMITS_SUMMARY<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS_SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for existing issue
        id: existing
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Upstream has new commits')
            );

            if (existingIssue) {
              console.log(`Found existing issue #${existingIssue.number}`);
              return existingIssue.number;
            }
            return null;

      - name: Create or update issue
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const behindCount = '${{ steps.check.outputs.behind_count }}';
            const commitsSummary = `${{ steps.check.outputs.COMMITS_SUMMARY }}`;
            const existingIssue = ${{ steps.existing.outputs.result || 'null' }};

            const title = `Upstream has new commits (${behindCount} behind)`;
            const body = commitsSummary + '\n\n---\n_This issue was automatically created by the upstream-check workflow._';
            const labels = ['upstream-sync'];

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue,
                title: title,
                body: body
              });
              console.log(`Updated issue #${existingIssue}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.has_updates }}" == "true" ]; then
            echo "::notice::Upstream has ${{ steps.check.outputs.behind_count }} new commits"
          else
            echo "::notice::Fork is up to date with upstream"
          fi
